<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
  // Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAhvUQC6SWtZ8aFMpRu0owWT1MVcq_t_Fo",
  authDomain: "attendence-list-lbs.firebaseapp.com",
  databaseURL: "https://attendence-list-lbs-default-rtdb.firebaseio.com",
  projectId: "attendence-list-lbs",
  storageBucket: "attendence-list-lbs.firebasestorage.app",
  messagingSenderId: "874744289039",
  appId: "1:874744289039:web:67d16e57a1c4ca0a48107a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      background-color: #f4f4f9;
    }
    .sidebar {
      height: 100vh;
      width: 250px;
      background-color: #1a1a1a;
      color: white;
      transition: width 0.3s;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      padding-top: 10px;
      z-index: 1000;
    }
    .collapsed {
      width: 60px;
    }
    .menu-button {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      margin: 10px;
      align-self: flex-start;
    }
    .menu-items {
      list-style: none;
      padding: 0;
      flex-grow: 1;
    }
    .menu-items li {
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .menu-items li:hover {
      background-color: #444;
    }
    .icon {
      width: 24px;
    }
    .text {
      white-space: nowrap;
    }
    .content {
      margin-left: 260px;
      padding: 20px;
      flex-grow: 1;
      transition: margin-left 0.3s;
    }
    .collapsed ~ .content {
      margin-left: 70px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="menu-button" onclick="toggleSidebar()">‚ò∞</button>
    <ul class="menu-items">
      <li onclick="showContent('profile')"><span class="icon">üë§</span><span class="text">Profile</span></li>
      <li onclick="showContent('attendance')"><span class="icon">üìÖ</span><span class="text">Attendance</span></li>
      <li onclick="showContent('face-recognition')"><span class="icon">üì∏</span><span class="text">Face Recognition</span></li>
      <li onclick="showContent('students')"><span class="icon">üë®‚Äçüéì</span><span class="text">Students</span></li>
      <li onclick="showContent('reports')"><span class="icon">üìÑ</span><span class="text">Reports</span></li>
      <li onclick="logout()"><span class="icon">üö™</span><span class="text">Logout</span></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="content" id="content">
    <h1>Welcome to the Teacher Dashboard</h1>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("collapsed");
    }

    function showContent(section) {
      const content = document.getElementById("content");
      if (section === "attendance") {
        content.innerHTML = `
          <h2>üìÖ Attendance Report</h2>
          <form id="attendanceForm" class="mb-4">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Branch</label>
                <select id="branch" class="form-select"><option>IT</option><option>CS</option></select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Batch</label>
                <select id="batch" class="form-select"><option>2021-2025</option><option>2022-2026</option></select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Semester</label>
                <select id="semester" class="form-select"><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Subject</label>
                <select id="subject" class="form-select"><option>Data Science</option><option>Mathematics</option></select>
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Fetch Attendance</button>
          </form>
          <table id="attendance-table" class="table table-striped">
            <thead><tr><th>Student ID</th><th>Date</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>`;
        document.getElementById("attendanceForm").addEventListener("submit", e => {
          e.preventDefault();
          fetchAttendance();
        });
      } else if (section === "face-recognition") {
        content.innerHTML = `
          <h2>üì∏ Face Recognition Attendance</h2>
          <div class="row g-3 mb-3">
            <div class="col-md-3"><label class="form-label">Branch</label><select id="branch" class="form-select"><option>IT</option><option>CS</option></select></div>
            <div class="col-md-3"><label class="form-label">Batch</label><select id="batch" class="form-select"><option>2021-2025</option><option>2022-2026</option></select></div>
            <div class="col-md-3"><label class="form-label">Semester</label><select id="semester" class="form-select"><option value="1">Semester 1</option><option value="2">Semester 2</option></select></div>
            <div class="col-md-3"><label class="form-label">Subject</label><select id="subject" class="form-select"><option>Data Science</option><option>Mathematics</option></select></div>
          </div>
          <div class="mb-3">
            <video id="video" autoplay class="border"></video><br>
            <button id="capture-btn" class="btn btn-success mt-2">Capture</button>
          </div>
          <canvas id="canvas" style="display:none;"></canvas>
          <div id="result" class="mt-3">Awaiting recognition...</div>`;
        initFaceRecognition();
      } else  if (section === "profile") {
    content.innerHTML = `
      <h2>üë§ Profile</h2>
      <div>
        <p><strong>Name:</strong> John Doe</p>
        <p><strong>Email:</strong> johndoe@example.com</p>
        <p><strong>Branch:</strong> Computer Science</p>
        <p><strong>Position:</strong> Faculty</p>
      </div>
      <button class="btn btn-primary">Edit Profile</button>
    `;
  }else if (section === "students") {
    content.innerHTML = `
      <h2>üë®‚Äçüéì Students</h2>
      <table>
        <thead>
          <tr><th>Student ID</th><th>Name</th><th>Email</th><th>Batch</th></tr>
        </thead>
        <tbody>
          <tr><td>12345</td><td>Jane Doe</td><td>janedoe@example.com</td><td>2021-2025</td></tr>
          <tr><td>67890</td><td>John Smith</td><td>johnsmith@example.com</td><td>2022-2026</td></tr>
        </tbody>
      </table>
      <button class="btn btn-primary">Add Student</button>
    `;
  }else  if (section === "reports") {
    content.innerHTML = `
      <h2>üìÑ Attendance Reports</h2>
      <div class="row g-3 mb-3">
        <div class="col-md-3"><label class="form-label">Branch</label><select id="branch" class="form-select"><option>IT</option><option>CS</option></select></div>
        <div class="col-md-3"><label class="form-label">Batch</label><select id="batch" class="form-select"><option>2021-2025</option><option>2022-2026</option></select></div>
        <div class="col-md-3"><label class="form-label">Semester</label><select id="semester" class="form-select"><option value="1">Semester 1</option><option value="2">Semester 2</option></select></div>
        <div class="col-md-3"><label class="form-label">Subject</label><select id="subject" class="form-select"><option>Data Science</option><option>Mathematics</option></select></div>
      </div>
      <button id="generate-report-btn" class="btn btn-primary mt-3">Generate Report</button>

      <div id="attendance-report" class="mt-4"></div>
      <canvas id="attendance-chart" width="400" height="200"></canvas>
    `;

    // Generate report button
    document.getElementById("generate-report-btn").addEventListener("click", () => {
      const branch = document.getElementById("branch").value;
      const batch = document.getElementById("batch").value;
      const semester = document.getElementById("semester").value;
      const subject = document.getElementById("subject").value;

      fetchAttendanceReport(branch, batch, semester, subject);
    });
  } else {
    content.innerHTML = `<h1>${section.charAt(0).toUpperCase() + section.slice(1)} Section</h1>`;
  }
}

function fetchAttendanceReport(branch, batch, semester, subject) {
            const attendanceRef = db.collection("attendance");

            attendanceRef.where("branch", "==", branch)
                .where("batch", "==", batch)
                .where("semester", "==", semester)
                .where("subject", "==", subject)
                .get()
                .then((querySnapshot) => {
                    const reportData = [];
                    querySnapshot.forEach((doc) => {
                        reportData.push(doc.data());
                    });

                    if (reportData.length > 0) {
                        // Display Attendance Report in a table
                        const reportContainer = document.getElementById("attendance-report");
                        const reportTable = document.createElement("table");
                        reportTable.className = "table table-striped";
                        reportTable.innerHTML = `
                            <thead>
                                <tr><th>Date</th><th>Present</th><th>Absent</th></tr>
                            </thead>
                            <tbody>
                                ${reportData.map(row => `
                                    <tr>
                                        <td>${new Date(row.date.seconds * 1000).toLocaleDateString()}</td>
                                        <td>${row.present}</td>
                                        <td>${row.absent}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                        reportContainer.innerHTML = "";
                        reportContainer.appendChild(reportTable);

                        // Create Attendance Graph (Bar chart)
                        const labels = reportData.map(row => new Date(row.date.seconds * 1000).toLocaleDateString());
                        const presentData = reportData.map(row => row.present);
                        const absentData = reportData.map(row => row.absent);

                        const ctx = document.getElementById("attendance-chart").getContext("2d");
                        new Chart(ctx, {
                            type: "bar",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: "Present",
                                        data: presentData,
                                        backgroundColor: "#28a745", // Green color for present
                                    },
                                    {
                                        label: "Absent",
                                        data: absentData,
                                        backgroundColor: "#dc3545", // Red color for absent
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: { beginAtZero: true },
                                    y: { beginAtZero: true }
                                },
                                plugins: {
                                    legend: { position: "top" },
                                    tooltip: { callbacks: { label: (tooltipItem) => `${tooltipItem.raw} students` } }
                                }
                            }
                        });
                    } else {
                        alert("No attendance data available for the selected filters.");
                    }
                })
                .catch((error) => {
                    console.error("Error getting attendance data:", error);
                });
        }

        // Function to Trigger Report Generation
        function generateReport() {
            const branch = document.getElementById("branch").value;
            const batch = document.getElementById("batch").value;
            const semester = document.getElementById("semester").value;
            const subject = document.getElementById("subject").value;

            fetchAttendanceReport(branch, batch, semester, subject);
}

    function fetchAttendance() {
      const branch = document.getElementById("branch").value;
      const batch = document.getElementById("batch").value;
      const semester = document.getElementById("semester").value;
      const subject = document.getElementById("subject").value;

      fetch(`/get_attendance?branch=${branch}&batch=${batch}&semester=${semester}&subject=${subject}`)
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("#attendance-table tbody");
          tbody.innerHTML = "";
          if (!data.attendance || data.attendance.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3">No records found</td></tr>`;
            return;
          }
          data.attendance.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = r.student_id;
            row.insertCell(1).textContent = new Date(r.timestamp).toLocaleString();
            row.insertCell(2).textContent = r.status;
          });
        })
        .catch(err => {
          console.error("‚ùå Fetch Error:", err);
          alert("Error fetching attendance.");
        });
    }

    function initFaceRecognition() {
      const video = document.getElementById("video");
      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
      });

      document.getElementById("capture-btn").addEventListener("click", () => {
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL("image/jpeg").split(",")[1];

        fetch("http://127.0.0.1:5000/recognize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: imageData }),
        })
          .then(res => res.json())
          .then(data => {
            if (data.student) {
              document.getElementById("result").textContent = `‚úÖ Recognized: ${data.student}`;
              markAttendance(data.student);
            } else {
              document.getElementById("result").textContent = "‚ùå Not Recognized";
            }
          })
          .catch(err => console.error("Recognition error:", err));
      });
    }

    function markAttendance(studentId) {
      const branch = document.getElementById("branch").value;
      const batch = document.getElementById("batch").value;
      const semester = document.getElementById("semester").value;
      const subject = document.getElementById("subject").value;

      fetch("http://127.0.0.1:5000/mark_attendance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ student_id: studentId, branch, batch, semester, subject }),
      })
        .then(res => res.json())
        .then(data => alert(data.message || "‚úÖ Attendance Marked!"))
        .catch(err => console.error("Mark error:", err));
    }

    function logout() {
      window.location.href = "teacherfacetlogin.html";
    }
  </script>
</body>
</html>
